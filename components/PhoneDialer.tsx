"use client";

import React, { useState, useEffect, useCallback, useRef } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { useAuth } from "../contexts/AuthContext";
import Auth from "./Auth";
import { useTwilio } from "../contexts/TwilioContext";
import TwilioDebugPanel from "./TwilioDebugPanel";
import CreditBalance from "./CreditBalance";
import Link from "next/link";
import CallInfo from "./CallInfo";
import LowCreditWarning from "./LowCreditWarning";
import CallCreditInfo from "@/app/components/CallCreditInfo";
import {
  PhoneIcon,
  BackspaceIcon,
  ChevronDownIcon,
  MagnifyingGlassIcon,
  XMarkIcon,
  SpeakerXMarkIcon,
  SpeakerWaveIcon,
  ClockIcon,
  CurrencyDollarIcon,
} from "@heroicons/react/24/outline";
import { playDTMF, cleanupAudio } from "@/lib/audio";
import { deductCreditsForCall } from "@/lib/credits";

// Country codes data
const countryCodes = [
  { code: "+93", name: "Afghanistan", flag: "ğŸ‡¦ğŸ‡«" },
  { code: "+355", name: "Albania", flag: "ğŸ‡¦ğŸ‡±" },
  { code: "+213", name: "Algeria", flag: "ğŸ‡©ğŸ‡¿" },
  { code: "+1684", name: "American Samoa", flag: "ğŸ‡¦ğŸ‡¸" },
  { code: "+376", name: "Andorra", flag: "ğŸ‡¦ğŸ‡©" },
  { code: "+244", name: "Angola", flag: "ğŸ‡¦ğŸ‡´" },
  { code: "+1264", name: "Anguilla", flag: "ğŸ‡¦ğŸ‡®" },
  { code: "+672", name: "Antarctica", flag: "ğŸ‡¦ğŸ‡¶" },
  { code: "+1268", name: "Antigua and Barbuda", flag: "ğŸ‡¦ğŸ‡¬" },
  { code: "+54", name: "Argentina", flag: "ğŸ‡¦ğŸ‡·" },
  { code: "+374", name: "Armenia", flag: "ğŸ‡¦ğŸ‡²" },
  { code: "+297", name: "Aruba", flag: "ğŸ‡¦ğŸ‡¼" },
  { code: "+61", name: "Australia", flag: "ğŸ‡¦ğŸ‡º" },
  { code: "+43", name: "Austria", flag: "ğŸ‡¦ğŸ‡¹" },
  { code: "+994", name: "Azerbaijan", flag: "ğŸ‡¦ğŸ‡¿" },
  { code: "+1242", name: "Bahamas", flag: "ğŸ‡§ğŸ‡¸" },
  { code: "+973", name: "Bahrain", flag: "ğŸ‡§ğŸ‡­" },
  { code: "+880", name: "Bangladesh", flag: "ğŸ‡§ğŸ‡©" },
  { code: "+1246", name: "Barbados", flag: "ğŸ‡§ğŸ‡§" },
  { code: "+375", name: "Belarus", flag: "ğŸ‡§ğŸ‡¾" },
  { code: "+32", name: "Belgium", flag: "ğŸ‡§ğŸ‡ª" },
  { code: "+501", name: "Belize", flag: "ğŸ‡§ğŸ‡¿" },
  { code: "+229", name: "Benin", flag: "ğŸ‡§ğŸ‡¯" },
  { code: "+1441", name: "Bermuda", flag: "ğŸ‡§ğŸ‡²" },
  { code: "+975", name: "Bhutan", flag: "ğŸ‡§ğŸ‡¹" },
  { code: "+591", name: "Bolivia", flag: "ğŸ‡§ğŸ‡´" },
  { code: "+387", name: "Bosnia and Herzegovina", flag: "ğŸ‡§ğŸ‡¦" },
  { code: "+267", name: "Botswana", flag: "ğŸ‡§ğŸ‡¼" },
  { code: "+55", name: "Brazil", flag: "ğŸ‡§ğŸ‡·" },
  { code: "+246", name: "British Indian Ocean Territory", flag: "ğŸ‡®ğŸ‡´" },
  { code: "+1284", name: "British Virgin Islands", flag: "ğŸ‡»ğŸ‡¬" },
  { code: "+673", name: "Brunei", flag: "ğŸ‡§ğŸ‡³" },
  { code: "+359", name: "Bulgaria", flag: "ğŸ‡§ğŸ‡¬" },
  { code: "+226", name: "Burkina Faso", flag: "ğŸ‡§ğŸ‡«" },
  { code: "+257", name: "Burundi", flag: "ğŸ‡§ğŸ‡®" },
  { code: "+855", name: "Cambodia", flag: "ğŸ‡°ğŸ‡­" },
  { code: "+237", name: "Cameroon", flag: "ğŸ‡¨ğŸ‡²" },
  { code: "+1", name: "Canada", flag: "ğŸ‡¨ğŸ‡¦" },
  { code: "+238", name: "Cape Verde", flag: "ğŸ‡¨ğŸ‡»" },
  { code: "+1345", name: "Cayman Islands", flag: "ğŸ‡°ğŸ‡¾" },
  { code: "+236", name: "Central African Republic", flag: "ğŸ‡¨ğŸ‡«" },
  { code: "+235", name: "Chad", flag: "ğŸ‡¹ğŸ‡©" },
  { code: "+56", name: "Chile", flag: "ğŸ‡¨ğŸ‡±" },
  { code: "+86", name: "China", flag: "ğŸ‡¨ğŸ‡³" },
  { code: "+61", name: "Christmas Island", flag: "ğŸ‡¨ğŸ‡½" },
  { code: "+61", name: "Cocos Islands", flag: "ğŸ‡¨ğŸ‡¨" },
  { code: "+57", name: "Colombia", flag: "ğŸ‡¨ğŸ‡´" },
  { code: "+269", name: "Comoros", flag: "ğŸ‡°ğŸ‡²" },
  { code: "+682", name: "Cook Islands", flag: "ğŸ‡¨ğŸ‡°" },
  { code: "+506", name: "Costa Rica", flag: "ğŸ‡¨ğŸ‡·" },
  { code: "+385", name: "Croatia", flag: "ğŸ‡­ğŸ‡·" },
  { code: "+53", name: "Cuba", flag: "ğŸ‡¨ğŸ‡º" },
  { code: "+599", name: "Curacao", flag: "ğŸ‡¨ğŸ‡¼" },
  { code: "+357", name: "Cyprus", flag: "ğŸ‡¨ğŸ‡¾" },
  { code: "+420", name: "Czech Republic", flag: "ğŸ‡¨ğŸ‡¿" },
  { code: "+243", name: "Democratic Republic of the Congo", flag: "ğŸ‡¨ğŸ‡©" },
  { code: "+45", name: "Denmark", flag: "ğŸ‡©ğŸ‡°" },
  { code: "+253", name: "Djibouti", flag: "ğŸ‡©ğŸ‡¯" },
  { code: "+1767", name: "Dominica", flag: "ğŸ‡©ğŸ‡²" },
  { code: "+1809", name: "Dominican Republic", flag: "ğŸ‡©ğŸ‡´" },
  { code: "+670", name: "East Timor", flag: "ğŸ‡¹ğŸ‡±" },
  { code: "+593", name: "Ecuador", flag: "ğŸ‡ªğŸ‡¨" },
  { code: "+20", name: "Egypt", flag: "ğŸ‡ªğŸ‡¬" },
  { code: "+503", name: "El Salvador", flag: "ğŸ‡¸ğŸ‡»" },
  { code: "+240", name: "Equatorial Guinea", flag: "ğŸ‡¬ğŸ‡¶" },
  { code: "+291", name: "Eritrea", flag: "ğŸ‡ªğŸ‡·" },
  { code: "+372", name: "Estonia", flag: "ğŸ‡ªğŸ‡ª" },
  { code: "+251", name: "Ethiopia", flag: "ğŸ‡ªğŸ‡¹" },
  { code: "+500", name: "Falkland Islands", flag: "ğŸ‡«ğŸ‡°" },
  { code: "+298", name: "Faroe Islands", flag: "ğŸ‡«ğŸ‡´" },
  { code: "+679", name: "Fiji", flag: "ğŸ‡«ğŸ‡¯" },
  { code: "+358", name: "Finland", flag: "ğŸ‡«ğŸ‡®" },
  { code: "+33", name: "France", flag: "ğŸ‡«ğŸ‡·" },
  { code: "+594", name: "French Guiana", flag: "ğŸ‡¬ğŸ‡«" },
  { code: "+689", name: "French Polynesia", flag: "ğŸ‡µğŸ‡«" },
  { code: "+241", name: "Gabon", flag: "ğŸ‡¬ğŸ‡¦" },
  { code: "+220", name: "Gambia", flag: "ğŸ‡¬ğŸ‡²" },
  { code: "+995", name: "Georgia", flag: "ğŸ‡¬ğŸ‡ª" },
  { code: "+49", name: "Germany", flag: "ğŸ‡©ğŸ‡ª" },
  { code: "+233", name: "Ghana", flag: "ğŸ‡¬ğŸ‡­" },
  { code: "+350", name: "Gibraltar", flag: "ğŸ‡¬ğŸ‡®" },
  { code: "+30", name: "Greece", flag: "ğŸ‡¬ğŸ‡·" },
  { code: "+299", name: "Greenland", flag: "ğŸ‡¬ğŸ‡±" },
  { code: "+1473", name: "Grenada", flag: "ğŸ‡¬ğŸ‡©" },
  { code: "+590", name: "Guadeloupe", flag: "ğŸ‡¬ğŸ‡µ" },
  { code: "+1671", name: "Guam", flag: "ğŸ‡¬ğŸ‡º" },
  { code: "+502", name: "Guatemala", flag: "ğŸ‡¬ğŸ‡¹" },
  { code: "+44", name: "Guernsey", flag: "ğŸ‡¬ğŸ‡¬" },
  { code: "+224", name: "Guinea", flag: "ğŸ‡¬ğŸ‡³" },
  { code: "+245", name: "Guinea-Bissau", flag: "ğŸ‡¬ğŸ‡¼" },
  { code: "+592", name: "Guyana", flag: "ğŸ‡¬ğŸ‡¾" },
  { code: "+509", name: "Haiti", flag: "ğŸ‡­ğŸ‡¹" },
  { code: "+504", name: "Honduras", flag: "ğŸ‡­ğŸ‡³" },
  { code: "+852", name: "Hong Kong", flag: "ğŸ‡­ğŸ‡°" },
  { code: "+36", name: "Hungary", flag: "ğŸ‡­ğŸ‡º" },
  { code: "+354", name: "Iceland", flag: "ğŸ‡®ğŸ‡¸" },
  { code: "+91", name: "India", flag: "ğŸ‡®ğŸ‡³" },
  { code: "+62", name: "Indonesia", flag: "ğŸ‡®ğŸ‡©" },
  { code: "+98", name: "Iran", flag: "ğŸ‡®ğŸ‡·" },
  { code: "+964", name: "Iraq", flag: "ğŸ‡®ğŸ‡¶" },
  { code: "+353", name: "Ireland", flag: "ğŸ‡®ğŸ‡ª" },
  { code: "+44", name: "Isle of Man", flag: "ğŸ‡®ğŸ‡²" },
  { code: "+972", name: "Israel", flag: "ğŸ‡®ğŸ‡±" },
  { code: "+39", name: "Italy", flag: "ğŸ‡®ğŸ‡¹" },
  { code: "+225", name: "Ivory Coast", flag: "ğŸ‡¨ğŸ‡®" },
  { code: "+1876", name: "Jamaica", flag: "ğŸ‡¯ğŸ‡²" },
  { code: "+81", name: "Japan", flag: "ğŸ‡¯ğŸ‡µ" },
  { code: "+44", name: "Jersey", flag: "ğŸ‡¯ğŸ‡ª" },
  { code: "+962", name: "Jordan", flag: "ğŸ‡¯ğŸ‡´" },
  { code: "+7", name: "Kazakhstan", flag: "ğŸ‡°ğŸ‡¿" },
  { code: "+254", name: "Kenya", flag: "ğŸ‡°ğŸ‡ª" },
  { code: "+686", name: "Kiribati", flag: "ğŸ‡°ğŸ‡®" },
  { code: "+383", name: "Kosovo", flag: "ğŸ‡½ğŸ‡°" },
  { code: "+965", name: "Kuwait", flag: "ğŸ‡°ğŸ‡¼" },
  { code: "+996", name: "Kyrgyzstan", flag: "ğŸ‡°ğŸ‡¬" },
  { code: "+856", name: "Laos", flag: "ğŸ‡±ğŸ‡¦" },
  { code: "+371", name: "Latvia", flag: "ğŸ‡±ğŸ‡»" },
  { code: "+961", name: "Lebanon", flag: "ğŸ‡±ğŸ‡§" },
  { code: "+266", name: "Lesotho", flag: "ğŸ‡±ğŸ‡¸" },
  { code: "+231", name: "Liberia", flag: "ğŸ‡±ğŸ‡·" },
  { code: "+218", name: "Libya", flag: "ğŸ‡±ğŸ‡¾" },
  { code: "+423", name: "Liechtenstein", flag: "ğŸ‡±ğŸ‡®" },
  { code: "+370", name: "Lithuania", flag: "ï¿½ï¿½ğŸ‡»" },
  { code: "+352", name: "Luxembourg", flag: "ğŸ‡±ğŸ‡º" },
  { code: "+853", name: "Macau", flag: "ğŸ‡²ğŸ‡´" },
  { code: "+389", name: "Macedonia", flag: "ğŸ‡²ğŸ‡°" },
  { code: "+261", name: "Madagascar", flag: "ğŸ‡²ğŸ‡¬" },
  { code: "+265", name: "Malawi", flag: "ğŸ‡²ğŸ‡¼" },
  { code: "+60", name: "Malaysia", flag: "ğŸ‡²ğŸ‡¾" },
  { code: "+960", name: "Maldives", flag: "ğŸ‡²ğŸ‡»" },
  { code: "+223", name: "Mali", flag: "ğŸ‡²ğŸ‡±" },
  { code: "+356", name: "Malta", flag: "ğŸ‡²ğŸ‡¹" },
  { code: "+692", name: "Marshall Islands", flag: "ğŸ‡²ğŸ‡­" },
  { code: "+596", name: "Martinique", flag: "ğŸ‡²ğŸ‡¶" },
  { code: "+222", name: "Mauritania", flag: "ğŸ‡²ğŸ‡·" },
  { code: "+230", name: "Mauritius", flag: "ğŸ‡²ğŸ‡º" },
  { code: "+262", name: "Mayotte", flag: "ğŸ‡¾ğŸ‡¹" },
  { code: "+52", name: "Mexico", flag: "ğŸ‡²ğŸ‡½" },
  { code: "+691", name: "Micronesia", flag: "ğŸ‡«ğŸ‡²" },
  { code: "+373", name: "Moldova", flag: "ğŸ‡²ğŸ‡©" },
  { code: "+377", name: "Monaco", flag: "ğŸ‡²ğŸ‡¨" },
  { code: "+976", name: "Mongolia", flag: "ğŸ‡²ğŸ‡³" },
  { code: "+382", name: "Montenegro", flag: "ğŸ‡²ğŸ‡ª" },
  { code: "+1664", name: "Montserrat", flag: "ğŸ‡²ğŸ‡¸" },
  { code: "+212", name: "Morocco", flag: "ğŸ‡²ğŸ‡¦" },
  { code: "+258", name: "Mozambique", flag: "ğŸ‡²ğŸ‡¿" },
  { code: "+95", name: "Myanmar", flag: "ğŸ‡²ğŸ‡²" },
  { code: "+264", name: "Namibia", flag: "ğŸ‡³ğŸ‡¦" },
  { code: "+674", name: "Nauru", flag: "ğŸ‡³ğŸ‡·" },
  { code: "+977", name: "Nepal", flag: "ğŸ‡³ğŸ‡µ" },
  { code: "+31", name: "Netherlands", flag: "ğŸ‡³ğŸ‡±" },
  { code: "+687", name: "New Caledonia", flag: "ğŸ‡³ğŸ‡¨" },
  { code: "+64", name: "New Zealand", flag: "ğŸ‡³ğŸ‡¿" },
  { code: "+505", name: "Nicaragua", flag: "ğŸ‡³ğŸ‡®" },
  { code: "+227", name: "Niger", flag: "ğŸ‡³ğŸ‡ª" },
  { code: "+234", name: "Nigeria", flag: "ğŸ‡³ğŸ‡¬" },
  { code: "+683", name: "Niue", flag: "ğŸ‡³ğŸ‡º" },
  { code: "+850", name: "North Korea", flag: "ğŸ‡°ğŸ‡µ" },
  { code: "+1670", name: "Northern Mariana Islands", flag: "ğŸ‡²ğŸ‡µ" },
  { code: "+47", name: "Norway", flag: "ğŸ‡³ğŸ‡´" },
  { code: "+968", name: "Oman", flag: "ğŸ‡´ğŸ‡²" },
  { code: "+92", name: "Pakistan", flag: "ğŸ‡µğŸ‡°" },
  { code: "+680", name: "Palau", flag: "ğŸ‡µğŸ‡¼" },
  { code: "+970", name: "Palestine", flag: "ğŸ‡µğŸ‡¸" },
  { code: "+507", name: "Panama", flag: "ğŸ‡µğŸ‡¦" },
  { code: "+675", name: "Papua New Guinea", flag: "ğŸ‡µğŸ‡¬" },
  { code: "+595", name: "Paraguay", flag: "ğŸ‡µğŸ‡¾" },
  { code: "+51", name: "Peru", flag: "ğŸ‡µğŸ‡ª" },
  { code: "+63", name: "Philippines", flag: "ğŸ‡µğŸ‡­" },
  { code: "+48", name: "Poland", flag: "ğŸ‡µğŸ‡±" },
  { code: "+351", name: "Portugal", flag: "ğŸ‡µğŸ‡¹" },
  { code: "+1787", name: "Puerto Rico", flag: "ğŸ‡µğŸ‡·" },
  { code: "+974", name: "Qatar", flag: "ğŸ‡¶ğŸ‡¦" },
  { code: "+242", name: "Republic of the Congo", flag: "ğŸ‡¨ğŸ‡¬" },
  { code: "+262", name: "Reunion", flag: "ğŸ‡·ğŸ‡ª" },
  { code: "+40", name: "Romania", flag: "ğŸ‡·ğŸ‡´" },
  { code: "+7", name: "Russia", flag: "ğŸ‡·ğŸ‡º" },
  { code: "+250", name: "Rwanda", flag: "ğŸ‡·ğŸ‡¼" },
  { code: "+590", name: "Saint Barthelemy", flag: "ğŸ‡§ğŸ‡±" },
  { code: "+290", name: "Saint Helena", flag: "ğŸ‡¸ğŸ‡­" },
  { code: "+1869", name: "Saint Kitts and Nevis", flag: "ğŸ‡°ğŸ‡³" },
  { code: "+1758", name: "Saint Lucia", flag: "ğŸ‡±ğŸ‡¨" },
  { code: "+590", name: "Saint Martin", flag: "ğŸ‡²ğŸ‡«" },
  { code: "+508", name: "Saint Pierre and Miquelon", flag: "ğŸ‡µğŸ‡²" },
  { code: "+1784", name: "Saint Vincent and the Grenadines", flag: "ğŸ‡»ğŸ‡¨" },
  { code: "+685", name: "Samoa", flag: "ğŸ‡¼ğŸ‡¸" },
  { code: "+378", name: "San Marino", flag: "ğŸ‡¸ğŸ‡²" },
  { code: "+239", name: "Sao Tome and Principe", flag: "ğŸ‡¸ğŸ‡¹" },
  { code: "+966", name: "Saudi Arabia", flag: "ğŸ‡¸ğŸ‡¦" },
  { code: "+221", name: "Senegal", flag: "ğŸ‡¸ğŸ‡³" },
  { code: "+381", name: "Serbia", flag: "ğŸ‡·ğŸ‡¸" },
  { code: "+248", name: "Seychelles", flag: "ğŸ‡¸ğŸ‡¨" },
  { code: "+232", name: "Sierra Leone", flag: "ğŸ‡¸ğŸ‡±" },
  { code: "+65", name: "Singapore", flag: "ğŸ‡¸ğŸ‡¬" },
  { code: "+1721", name: "Sint Maarten", flag: "ğŸ‡¸ğŸ‡½" },
  { code: "+421", name: "Slovakia", flag: "ğŸ‡¸ğŸ‡°" },
  { code: "+386", name: "Slovenia", flag: "ğŸ‡¸ğŸ‡®" },
  { code: "+677", name: "Solomon Islands", flag: "ğŸ‡¸ğŸ‡§" },
  { code: "+252", name: "Somalia", flag: "ğŸ‡¸ğŸ‡´" },
  { code: "+27", name: "South Africa", flag: "ğŸ‡¿ğŸ‡¦" },
  { code: "+82", name: "South Korea", flag: "ğŸ‡°ğŸ‡·" },
  { code: "+211", name: "South Sudan", flag: "ğŸ‡¸ğŸ‡¸" },
  { code: "+34", name: "Spain", flag: "ğŸ‡ªğŸ‡¸" },
  { code: "+94", name: "Sri Lanka", flag: "ğŸ‡±ğŸ‡°" },
  { code: "+249", name: "Sudan", flag: "ğŸ‡¸ğŸ‡©" },
  { code: "+597", name: "Suriname", flag: "ğŸ‡¸ğŸ‡·" },
  { code: "+47", name: "Svalbard and Jan Mayen", flag: "ğŸ‡¸ğŸ‡¯" },
  { code: "+268", name: "Swaziland", flag: "ğŸ‡¸ğŸ‡¿" },
  { code: "+46", name: "Sweden", flag: "ğŸ‡¸ğŸ‡ª" },
  { code: "+41", name: "Switzerland", flag: "ğŸ‡¨ğŸ‡­" },
  { code: "+963", name: "Syria", flag: "ğŸ‡¸ğŸ‡¾" },
  { code: "+886", name: "Taiwan", flag: "ğŸ‡¹ğŸ‡¼" },
  { code: "+992", name: "Tajikistan", flag: "ğŸ‡¹ğŸ‡¯" },
  { code: "+255", name: "Tanzania", flag: "ğŸ‡¹ğŸ‡¿" },
  { code: "+66", name: "Thailand", flag: "ğŸ‡¹ğŸ‡­" },
  { code: "+228", name: "Togo", flag: "ğŸ‡¹ğŸ‡¬" },
  { code: "+690", name: "Tokelau", flag: "ğŸ‡¹ğŸ‡°" },
  { code: "+676", name: "Tonga", flag: "ğŸ‡¹ğŸ‡´" },
  { code: "+1868", name: "Trinidad and Tobago", flag: "ğŸ‡¹ğŸ‡¹" },
  { code: "+216", name: "Tunisia", flag: "ğŸ‡¹ğŸ‡³" },
  { code: "+90", name: "Turkey", flag: "ğŸ‡¹ğŸ‡·" },
  { code: "+993", name: "Turkmenistan", flag: "ğŸ‡¹ğŸ‡²" },
  { code: "+1649", name: "Turks and Caicos Islands", flag: "ğŸ‡¹ğŸ‡¨" },
  { code: "+688", name: "Tuvalu", flag: "ğŸ‡¹ğŸ‡»" },
  { code: "+1340", name: "U.S. Virgin Islands", flag: "ğŸ‡»ğŸ‡®" },
  { code: "+256", name: "Uganda", flag: "ğŸ‡ºğŸ‡¬" },
  { code: "+380", name: "Ukraine", flag: "ğŸ‡ºğŸ‡¦" },
  { code: "+971", name: "United Arab Emirates", flag: "ğŸ‡¦ğŸ‡ª" },
  { code: "+44", name: "United Kingdom", flag: "ğŸ‡¬ğŸ‡§" },
  { code: "+1", name: "United States", flag: "ğŸ‡ºğŸ‡¸" },
  { code: "+598", name: "Uruguay", flag: "ğŸ‡ºğŸ‡¾" },
  { code: "+998", name: "Uzbekistan", flag: "ğŸ‡ºğŸ‡¿" },
  { code: "+678", name: "Vanuatu", flag: "ğŸ‡»ğŸ‡º" },
  { code: "+379", name: "Vatican", flag: "ğŸ‡»ğŸ‡¦" },
  { code: "+58", name: "Venezuela", flag: "ğŸ‡»ğŸ‡ª" },
  { code: "+84", name: "Vietnam", flag: "ğŸ‡»ğŸ‡³" },
  { code: "+681", name: "Wallis and Futuna", flag: "ğŸ‡¼ğŸ‡«" },
  { code: "+212", name: "Western Sahara", flag: "ğŸ‡ªğŸ‡­" },
  { code: "+967", name: "Yemen", flag: "ğŸ‡¾ğŸ‡ª" },
  { code: "+260", name: "Zambia", flag: "ğŸ‡¿ğŸ‡²" },
  { code: "+263", name: "Zimbabwe", flag: "ğŸ‡¿ğŸ‡¼" },
];

interface PhoneDialerProps {
  user: any | null;
  loading: boolean;
}

interface DialButtonProps {
  value: string;
  onClick: () => void;
  disabled: boolean;
  className?: string;
}

// Dial button component with animation
const DialButton: React.FC<DialButtonProps> = ({
  value,
  onClick,
  disabled,
  className,
}) => {
  return (
    <motion.button
      key={value}
      onClick={onClick}
      className={`bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-4 rounded-md transition-colors relative ${className}`}
      disabled={disabled}
      whileTap={{ scale: 0.95 }}
      whileHover={{ backgroundColor: "#e5e7eb" }}
    >
      <div className="flex flex-col items-center justify-center">
        <span className="text-xl">{value}</span>
        {value === "0" && <span className="text-xs text-gray-500 mt-1">+</span>}
        {value === "1" && (
          <span className="text-xs text-gray-500 mt-1">Voicemail</span>
        )}
      </div>
    </motion.button>
  );
};

// Add a function to fetch call rate from our new API
async function fetchCallRate(phoneNumber: string): Promise<number> {
  try {
    const response = await fetch(
      `/api/rates/get-rate?phoneNumber=${encodeURIComponent(phoneNumber)}`
    );
    if (!response.ok) {
      console.error("Error fetching call rate:", response.statusText);
      return 0.1; // Default fallback rate
    }

    const data = await response.json();
    if (data.success && data.rate) {
      return data.rate;
    }
    return 0.1; // Default fallback rate
  } catch (error) {
    console.error("Error fetching call rate:", error);
    return 0.1; // Default fallback rate
  }
}

// Add a new Call Cost Timer component
interface CallCostTimerProps {
  isConnected: boolean;
  startTime: Date | null;
  rate: number;
  userId: string;
  phoneNumber: string;
  callSid?: string;
}

const CallCostTimer: React.FC<CallCostTimerProps> = ({
  isConnected,
  startTime,
  rate,
  userId,
  phoneNumber,
  callSid,
}) => {
  const [duration, setDuration] = useState(0);
  const [cost, setCost] = useState(0);
  const intervalRef = useRef<NodeJS.Timeout | null>(null);
  const lastDurationRef = useRef<number>(0);
  const lastCallStateRef = useRef<boolean>(isConnected);
  const [creditDeducted, setCreditDeducted] = useState(false);

  useEffect(() => {
    // Clear any existing interval
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }

    if (isConnected && startTime) {
      // Start the timer
      intervalRef.current = setInterval(() => {
        const currentDuration = Math.ceil(
          (Date.now() - startTime.getTime()) / 1000
        );
        setDuration(currentDuration);
        lastDurationRef.current = currentDuration;

        // Calculate cost: rate per minute * minutes (seconds / 60)
        const calculatedCost = (rate * currentDuration) / 60;
        setCost(parseFloat(calculatedCost.toFixed(4)));
      }, 1000);
    } else if (
      lastCallStateRef.current &&
      !isConnected &&
      userId &&
      lastDurationRef.current > 0 &&
      !creditDeducted
    ) {
      // Call just ended and we have duration data - deduct credits
      const durationMinutes = lastDurationRef.current / 60; // Convert seconds to minutes
      console.log(
        `Call ended. Deducting credits for ${durationMinutes.toFixed(
          2
        )} minutes at rate ${rate}/min`
      );

      setCreditDeducted(true); // Mark credits as deducted to prevent duplicate deductions

      // Deduct credits from the user's account
      deductCreditsForCall(
        userId,
        durationMinutes,
        callSid || "unknown",
        phoneNumber
      )
        .then((result) => {
          console.log("Credit deduction successful:", result);
        })
        .catch((err) => {
          console.error("Error deducting credits:", err);
        });

      // Reset when call ends
      setDuration(0);
      setCost(0);
    }

    // Update last call state reference
    lastCallStateRef.current = isConnected;

    // Cleanup on unmount
    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }

      // If component unmounts during an active call, we should still try to deduct credits
      if (
        isConnected &&
        userId &&
        lastDurationRef.current > 0 &&
        !creditDeducted
      ) {
        const durationMinutes = lastDurationRef.current / 60;
        console.log(
          `Component unmounting during call. Deducting credits for ${durationMinutes.toFixed(
            2
          )} minutes`
        );

        setCreditDeducted(true); // Mark as deducted

        deductCreditsForCall(
          userId,
          durationMinutes,
          callSid || "unknown",
          phoneNumber
        ).catch((err) => {
          console.error("Error deducting credits on unmount:", err);
        });
      }
    };
  }, [
    isConnected,
    startTime,
    rate,
    userId,
    phoneNumber,
    callSid,
    creditDeducted,
  ]);

  // When the call completely ends, reset the deducted state for next call
  useEffect(() => {
    if (!isConnected) {
      // Reset after a short delay to ensure the deduction has time to complete
      const resetTimer = setTimeout(() => {
        setCreditDeducted(false);
      }, 2000);

      return () => clearTimeout(resetTimer);
    }
  }, [isConnected]);

  // Format duration for display (MM:SS)
  const formatDuration = (seconds: number): string => {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, "0")}`;
  };

  if (!isConnected) return null;

  return (
    <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg mb-3 shadow-sm">
      <div className="flex justify-between items-center">
        <div className="flex items-center">
          <ClockIcon className="h-4 w-4 mr-2 text-blue-600" />
          <span className="text-blue-800 font-medium">
            {formatDuration(duration)}
          </span>
        </div>
        <div className="flex items-center">
          <CurrencyDollarIcon className="h-4 w-4 mr-2 text-blue-600" />
          <span className="text-blue-800 font-medium">${cost.toFixed(4)}</span>
        </div>
      </div>
    </div>
  );
};

export default function PhoneDialer({ user, loading }: PhoneDialerProps) {
  const [phoneNumber, setPhoneNumber] = useState("");
  const [showAuth, setShowAuth] = useState(false);
  const [micPermissionStatus, setMicPermissionStatus] = useState<
    "prompt" | "granted" | "denied"
  >("prompt");
  const [selectedCountryCode, setSelectedCountryCode] = useState(
    countryCodes.find((c) => c.code === "+1" && c.name === "United States") ||
      countryCodes.find((c) => c.code === "+1") ||
      countryCodes[0]
  );
  const [showCountryCodes, setShowCountryCodes] = useState(false);
  const [searchCountry, setSearchCountry] = useState("");
  const [filteredCountryCodes, setFilteredCountryCodes] =
    useState(countryCodes);
  const [longPressTimer, setLongPressTimer] = useState<NodeJS.Timeout | null>(
    null
  );
  const [initializationFailed, setInitializationFailed] = useState(false);
  // Add local state to track call status
  const [localCallState, setLocalCallState] = useState({
    isConnected: false,
    isConnecting: false,
    isMuted: false,
  });

  const countryDropdownRef = useRef<HTMLDivElement>(null);
  const searchInputRef = useRef<HTMLInputElement>(null);
  const initAttemptedRef = useRef<boolean>(false);
  const {
    isReady,
    isConnecting: twilioConnecting,
    isConnected: twilioConnected,
    error,
    connection,
    initializeDevice,
    makeCall,
    hangUp,
    callDuration,
    estimatedCost,
    insufficientCredits,
    isMuted,
    toggleMute,
    checkCredits,
    status,
    callStartTime,
  } = useTwilio();

  // Add state for call rate and SID
  const [callRate, setCallRate] = useState(0.1); // Default rate, will be updated when call starts
  const [callSid, setCallSid] = useState<string | undefined>(undefined);

  // Add useEffect to track connection state changes
  useEffect(() => {
    console.log("Call state changed:", {
      twilioConnected,
      twilioConnecting,
      status,
    });
    setLocalCallState((prev) => ({
      ...prev,
      isConnected: twilioConnected,
      isConnecting: twilioConnecting,
    }));
  }, [twilioConnected, twilioConnecting, status]);

  // Add a more aggressive check for call status
  useEffect(() => {
    // Force UI update when call duration increases
    if (callDuration > 0 && !localCallState.isConnected) {
      console.log("Call is active (duration > 0), forcing UI update");
      setLocalCallState((prev) => ({
        ...prev,
        isConnected: true,
        isConnecting: false,
      }));
    }
  }, [callDuration, localCallState.isConnected]);

  // Track mute state changes
  useEffect(() => {
    console.log("Mute state changed:", isMuted);
    setLocalCallState((prev) => ({
      ...prev,
      isMuted,
    }));
  }, [isMuted]);

  const [twilioNumber, setTwilioNumber] = useState<string | null>(null);
  const [hasEnoughCredits, setHasEnoughCredits] = useState(true);
  const [fullPhoneNumber, setFullPhoneNumber] = useState("");

  // Cleanup audio context on unmount
  useEffect(() => {
    return () => {
      cleanupAudio();
    };
  }, []);

  // Filter country codes when search input changes
  useEffect(() => {
    if (searchCountry) {
      const filtered = countryCodes.filter(
        (country) =>
          country.name.toLowerCase().includes(searchCountry.toLowerCase()) ||
          country.code.includes(searchCountry)
      );
      setFilteredCountryCodes(filtered);
    } else {
      setFilteredCountryCodes(countryCodes);
    }
  }, [searchCountry]);

  // Close country dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        countryDropdownRef.current &&
        !countryDropdownRef.current.contains(event.target as Node)
      ) {
        setShowCountryCodes(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, []);

  // Focus search input when country dropdown is shown
  useEffect(() => {
    if (showCountryCodes && searchInputRef.current) {
      setTimeout(() => {
        searchInputRef.current?.focus();
      }, 100);
    }
  }, [showCountryCodes]);

  // Add keyboard event handler
  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      // Only handle if not in a text input and not showing AI assistant
      if (
        event.target instanceof HTMLInputElement ||
        event.target instanceof HTMLTextAreaElement
      ) {
        return;
      }

      const key = event.key;

      // Handle numeric keys (both numpad and regular numbers)
      if (
        /^[0-9*#]$/.test(key) ||
        (event.code === "NumpadEnter" && key === "Enter")
      ) {
        event.preventDefault();
        handleNumberClick(key === "Enter" ? "#" : key);
      }
      // Handle backspace/delete
      else if (key === "Backspace" || key === "Delete") {
        event.preventDefault();
        handleDelete();
      }
      // Handle Enter key for making calls
      else if (key === "Enter" && !event.code.includes("Numpad")) {
        event.preventDefault();
        handleCall();
      }
      // Handle plus sign for international calls
      else if (key === "+" || key === "=") {
        event.preventDefault();
        if (phoneNumber.length === 0) {
          setPhoneNumber("+");
        }
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [phoneNumber]); // Add phoneNumber as dependency

  // Initialize Twilio when user is available
  useEffect(() => {
    if (user && !initAttemptedRef.current) {
      console.log("User available, initializing Twilio");
      initAttemptedRef.current = true;
      setInitializationFailed(false);

      initializeDevice().catch((err) => {
        console.error("Failed to initialize Twilio:", err);
        setInitializationFailed(true);
        // Reset the flag after a certain delay to allow retry
        setTimeout(() => {
          initAttemptedRef.current = false;
        }, 5000); // Wait 5 seconds before allowing another attempt
      });

      fetchTwilioNumber().catch((err) => {
        console.error("Failed to fetch Twilio number:", err);
      });
    }
  }, [user]); // Remove initializeDevice from the dependency array

  // Fetch the Twilio phone number
  const fetchTwilioNumber = async () => {
    try {
      const response = await fetch("/api/twilio/phone-number");
      if (response.ok) {
        const data = await response.json();
        if (data.phoneNumber) {
          // Format the phone number nicely for display
          const formattedNumber = formatPhoneNumberForDisplay(data.phoneNumber);
          setTwilioNumber(formattedNumber);
        }
      } else {
        // Handle non-200 responses
        console.warn(
          `Error fetching Twilio phone number: Server returned ${response.status}`
        );
        return false;
      }
      return true;
    } catch (error) {
      console.error("Error fetching Twilio phone number:", error);
      return false;
    }
  };

  // Update full phone number whenever phone number or country code changes
  useEffect(() => {
    if (phoneNumber) {
      // If phone number already starts with '+', don't add country code
      const formatted = phoneNumber.startsWith("+")
        ? phoneNumber
        : `${selectedCountryCode.code}${phoneNumber.replace(/\D/g, "")}`;
      setFullPhoneNumber(formatted);
    }
  }, [phoneNumber, selectedCountryCode]);

  // Check microphone permission status on mount
  useEffect(() => {
    async function checkMicPermission() {
      try {
        const result = await navigator.permissions.query({
          name: "microphone" as PermissionName,
        });
        setMicPermissionStatus(result.state as "prompt" | "granted" | "denied");

        // Listen for permission changes
        result.addEventListener("change", () => {
          setMicPermissionStatus(
            result.state as "prompt" | "granted" | "denied"
          );
        });
      } catch (err) {
        console.error("Error checking microphone permission:", err);
      }
    }

    checkMicPermission();
  }, []);

  // Handle microphone permission request
  const requestMicPermission = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach((track) => track.stop());
      setMicPermissionStatus("granted");
      return true;
    } catch (err) {
      console.error("Error requesting microphone permission:", err);
      setMicPermissionStatus("denied");
      return false;
    }
  };

  const handleNumberClick = (num: string) => {
    if (!user) {
      setShowAuth(true);
      return;
    }

    // Play DTMF tone
    playDTMF(num === "*" ? "*" : num === "#" ? "#" : num);

    setPhoneNumber((prev) => {
      // If "0" is long-pressed at the beginning, add "+"
      if (num === "0" && prev.length === 0) {
        return prev + "+";
      }
      return prev + num;
    });
  };

  const handleDelete = () => {
    if (phoneNumber) {
      playDTMF("#"); // Play a tone for delete as well
      setPhoneNumber((prev) => prev.slice(0, -1));
    }
  };

  const handleLongPressStart = (num: string) => {
    if (num === "0" && !longPressTimer) {
      const timer = setTimeout(() => {
        setPhoneNumber((prev) => {
          // Replace the last "0" with "+"
          if (prev.endsWith("0")) {
            return prev.slice(0, -1) + "+";
          }
          return prev + "+";
        });
      }, 700); // 700ms long press
      setLongPressTimer(timer);
    }
  };

  const handleLongPressEnd = () => {
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      setLongPressTimer(null);
    }
  };

  // Format phone number for making a call
  const formatPhoneNumberForCall = (
    number: string,
    countryCode: { code: string }
  ): string => {
    return number.startsWith("+")
      ? number
      : `${countryCode.code}${number.replace(/\D/g, "")}`;
  };

  const handleCall = async () => {
    if (!phoneNumber) {
      return;
    }

    // Format the full number with country code
    const fullNumber = formatPhoneNumberForCall(
      phoneNumber,
      selectedCountryCode
    );
    setFullPhoneNumber(fullNumber);

    // Check credits first
    const hasCredits = await checkCredits(10);
    if (!hasCredits) {
      return;
    }

    // Request microphone permission if not already granted
    if (micPermissionStatus !== "granted") {
      const permissionGranted = await requestMicPermission();
      if (!permissionGranted) {
        return;
      }
    }

    try {
      // Update local state to show connecting
      setLocalCallState((prev) => ({
        ...prev,
        isConnected: false,
        isConnecting: true,
      }));

      // Initialize the device if not already done
      if (!isReady) {
        console.log("Twilio device not ready, attempting to initialize...");
        // Only attempt initialization if we haven't tried recently
        if (!initAttemptedRef.current) {
          initAttemptedRef.current = true;
          console.log("Initializing Twilio device...");
          const initialized = await initializeDevice();
          console.log("Initialization result:", initialized);

          // If initialization failed, set a timeout to allow retry later
          if (!initialized) {
            console.error("Failed to initialize Twilio device");
            setLocalCallState((prev) => ({
              ...prev,
              isConnected: false,
              isConnecting: false,
            }));
            setTimeout(() => {
              initAttemptedRef.current = false;
            }, 5000);
            return;
          }
        } else {
          console.log(
            "Initialization already attempted recently, please wait and try again"
          );
          setLocalCallState((prev) => ({
            ...prev,
            isConnected: false,
            isConnecting: false,
          }));
          return;
        }
      }

      // Estimate the call rate based on the destination number using our API
      try {
        const rate = await fetchCallRate(fullNumber);
        setCallRate(rate);
        console.log(`Got rate for ${fullNumber}: $${rate}/min`);
      } catch (err) {
        console.error("Error fetching call rate:", err);
        // Continue with default rate if we can't get the specific rate
      }

      // Make the call
      console.log("Making call to:", fullNumber);
      const callSuccess = await makeCall(fullNumber);
      console.log("Call success:", callSuccess);

      if (callSuccess) {
        // Force update the local state to connected after a short delay
        // This ensures the UI updates even if the event handlers don't fire
        setTimeout(() => {
          setLocalCallState((prev) => ({
            ...prev,
            isConnected: true,
            isConnecting: false,
          }));
        }, 2000);
      } else {
        setLocalCallState((prev) => ({
          ...prev,
          isConnected: false,
          isConnecting: false,
        }));
      }

      if (!callSuccess && error?.includes("Authentication required")) {
        // If there's an authentication error, show the auth modal
        console.log("Authentication error detected, showing auth modal");
        setShowAuth(true);
      }
    } catch (err) {
      console.error("Error making call:", err);
      setLocalCallState((prev) => ({
        ...prev,
        isConnected: false,
        isConnecting: false,
      }));
    }
  };

  const handleHangUp = () => {
    console.log("Hanging up call");
    hangUp();

    // Immediately update local state to show disconnected
    setLocalCallState((prev) => ({
      ...prev,
      isConnected: false,
      isConnecting: false,
    }));
  };

  // Format phone number for display
  const formatPhoneNumberForDisplay = (number: string): string => {
    if (!number) return "";

    // Clean the number to remove any non-digit characters except the plus sign
    let cleanedNumber = number.replace(/[^\d+]/g, "");

    // Handle fully formatted international numbers
    if (cleanedNumber.startsWith("+")) {
      // For US/Canada numbers (+1)
      if (cleanedNumber.startsWith("+1") && cleanedNumber.length >= 12) {
        return `+1 (${cleanedNumber.substring(2, 5)}) ${cleanedNumber.substring(
          5,
          8
        )}-${cleanedNumber.substring(8)}`;
      }

      // For other international numbers, format with spaces
      return cleanedNumber.replace(
        /(\+\d{1,3})(\d{3})(\d{3})(\d{4})/,
        "$1 $2 $3 $4"
      );
    }

    // If the number doesn't start with a +, use the selected country code
    if (selectedCountryCode.code === "+1" && cleanedNumber.length >= 10) {
      return `(${cleanedNumber.slice(0, 3)}) ${cleanedNumber.slice(
        3,
        6
      )}-${cleanedNumber.slice(6, 10)}`;
    }

    // For other countries, add spaces every 3 digits
    return cleanedNumber.replace(/(\d{3})(?=\d)/g, "$1 ").trim();
  };

  // Add a manual retry function
  const handleRetryInitialization = () => {
    if (!initAttemptedRef.current && user) {
      setInitializationFailed(false);
      initAttemptedRef.current = true;

      initializeDevice()
        .then((success) => {
          if (success) {
            setInitializationFailed(false);
            return fetchTwilioNumber();
          } else {
            setInitializationFailed(true);
            throw new Error("Failed to initialize");
          }
        })
        .catch((err) => {
          console.error("Manual retry failed:", err);
          setInitializationFailed(true);
          // Reset the flag after delay
          setTimeout(() => {
            initAttemptedRef.current = false;
          }, 5000);
        });
    }
  };

  const handleMuteToggle = () => {
    // Log the current state for debugging
    console.log("Mute button clicked - Current state:", {
      localMuted: localCallState.isMuted,
      contextMuted: isMuted,
      isConnected: twilioConnected,
    });

    // Only allow muting if we're in a call
    if (!twilioConnected) {
      console.warn("Cannot mute - no active call");
      return;
    }

    // Update local state immediately for visual feedback
    setLocalCallState((prev) => ({
      ...prev,
      isMuted: !prev.isMuted,
    }));

    // Call the context's toggleMute function
    toggleMute();

    // Check if the state was properly updated after a short delay
    setTimeout(() => {
      console.log("Mute state after toggle:", {
        localMuted: localCallState.isMuted,
        contextMuted: isMuted,
        isConnected: twilioConnected,
      });

      // If there's a mismatch between local and context state, update local state
      if (localCallState.isMuted !== isMuted) {
        console.warn("Mute state mismatch detected, syncing states");
        setLocalCallState((prev) => ({
          ...prev,
          isMuted: isMuted,
        }));
      }
    }, 500);
  };

  // Update to track the call SID when connection object changes
  useEffect(() => {
    if (connection && connection.parameters && connection.parameters.CallSid) {
      setCallSid(connection.parameters.CallSid);
    } else {
      setCallSid(undefined);
    }
  }, [connection]);

  // Render authentication UI if user is not logged in
  if (!loading && !user) {
    return (
      <div className="w-full">
        <h1 className="text-2xl font-bold mb-4">Make a Call</h1>
        <p className="text-gray-600 mb-6">Enter a phone number to call</p>

        <div className="bg-red-100 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
          <p className="font-medium">Authentication Required</p>
          <p className="text-sm">You need to sign in to make phone calls.</p>
        </div>

        <button
          onClick={() => setShowAuth(true)}
          className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded transition-colors"
        >
          Sign In to Continue
        </button>

        {/* Auth Modal */}
        {showAuth && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="relative bg-white rounded-lg shadow-xl max-w-md w-full">
              <button
                className="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
                onClick={() => setShowAuth(false)}
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
              <Auth onSuccess={() => setShowAuth(false)} />
            </div>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="flex flex-col w-full max-w-md mx-auto bg-white rounded-xl shadow-sm p-5 border border-gray-200">
      <div className="mb-4">
        <h2 className="text-xl font-semibold text-gray-800">Phone Dialer</h2>
        {twilioNumber && (
          <p className="text-sm text-gray-600">
            Calling from: <span className="font-medium">{twilioNumber}</span>
          </p>
        )}
      </div>

      {/* Show retry button if initialization failed */}
      {initializationFailed && (
        <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
          <p className="text-sm text-red-700 mb-2">
            Failed to initialize the phone system. This could be due to a
            network issue.
          </p>
          <button
            onClick={handleRetryInitialization}
            disabled={initAttemptedRef.current}
            className="px-3 py-1 text-sm bg-red-100 hover:bg-red-200 text-red-800 rounded-md transition-colors"
          >
            {initAttemptedRef.current ? "Retrying..." : "Retry Connection"}
          </button>
        </div>
      )}

      {/* Credit Balance */}
      <div className="mb-4">
        <CreditBalance />
      </div>

      {/* Phone number input with country code */}
      <div
        className={`relative mb-4 ${
          localCallState.isConnected ? "opacity-50" : ""
        }`}
      >
        <div className="flex">
          {/* Country code selector */}
          <div className="relative" ref={countryDropdownRef}>
            <button
              type="button"
              onClick={() => setShowCountryCodes(!showCountryCodes)}
              className="flex items-center justify-between w-28 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50"
              disabled={localCallState.isConnected}
            >
              <span className="flex items-center">
                <span className="mr-2 text-lg">{selectedCountryCode.flag}</span>
                <span>{selectedCountryCode.code}</span>
              </span>
              <ChevronDownIcon className="w-4 h-4 ml-1 text-gray-500" />
            </button>

            {/* Country code dropdown with search */}
            <AnimatePresence>
              {showCountryCodes && (
                <motion.div
                  initial={{ opacity: 0, y: -10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -10 }}
                  transition={{ duration: 0.2 }}
                  className="absolute z-10 w-72 mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-80 overflow-hidden flex flex-col"
                >
                  <div className="p-2 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <div className="relative">
                      <MagnifyingGlassIcon className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                      <input
                        ref={searchInputRef}
                        type="text"
                        value={searchCountry}
                        onChange={(e) => setSearchCountry(e.target.value)}
                        placeholder="Search country or code..."
                        className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      {searchCountry && (
                        <button
                          onClick={() => setSearchCountry("")}
                          className="absolute right-3 top-2.5"
                        >
                          <XMarkIcon className="h-5 w-5 text-gray-400" />
                        </button>
                      )}
                    </div>
                  </div>
                  <div className="overflow-y-auto max-h-60">
                    {filteredCountryCodes.length === 0 ? (
                      <div className="p-4 text-gray-500 text-center">
                        No countries found
                      </div>
                    ) : (
                      filteredCountryCodes.map((country) => (
                        <button
                          key={`${country.code}-${country.name}`}
                          type="button"
                          className="flex items-center w-full px-4 py-2 text-left hover:bg-gray-100"
                          onClick={() => {
                            setSelectedCountryCode(country);
                            setShowCountryCodes(false);
                            setSearchCountry("");
                          }}
                        >
                          <span className="mr-2 text-lg">{country.flag}</span>
                          <span className="font-medium">{country.code}</span>
                          <span className="ml-2 text-sm text-gray-600">
                            {country.name}
                          </span>
                        </button>
                      ))
                    )}
                  </div>
                </motion.div>
              )}
            </AnimatePresence>
          </div>

          {/* Phone number input */}
          <div className="relative flex-grow">
            <input
              type="tel"
              value={formatPhoneNumberForDisplay(phoneNumber)}
              onChange={(e) => {
                // Filter non-numeric characters except for + at the beginning
                const value = e.target.value;
                const cleaned = value
                  .replace(/[^\d\s+()-]/g, "")
                  .replace(/\s+/g, " ");
                setPhoneNumber(cleaned);
              }}
              placeholder="Enter phone number"
              className="w-full h-full px-4 py-2 border border-gray-300 border-l-0 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
              disabled={localCallState.isConnected}
            />
            {phoneNumber && (
              <button
                onClick={handleDelete}
                className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                disabled={localCallState.isConnected}
              >
                <BackspaceIcon className="h-5 w-5" />
              </button>
            )}
          </div>
        </div>
      </div>

      {/* Credit Info for the call */}
      {fullPhoneNumber && (
        <div className="mb-4">
          <CallCreditInfo
            phoneNumber={fullPhoneNumber}
            onCreditCheck={(hasEnough) => setHasEnoughCredits(hasEnough)}
          />
        </div>
      )}

      {/* Error message */}
      {error && (
        <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-md">
          {error}
          {insufficientCredits && (
            <div className="mt-2">
              <Link
                href="/credits"
                className="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded transition-colors"
              >
                Add Credits
              </Link>
            </div>
          )}
        </div>
      )}

      {/* Microphone permission status message */}
      {micPermissionStatus === "denied" && (
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
          <p className="font-bold">Microphone access is required</p>
          <p className="text-sm">
            Please allow microphone access in your browser settings to make
            calls.
          </p>
        </div>
      )}

      {/* Add the Call Cost Timer component right before the keypad when on a call */}
      {localCallState.isConnected && (
        <CallCostTimer
          isConnected={localCallState.isConnected}
          startTime={callStartTime}
          rate={callRate}
          userId={user?.id}
          phoneNumber={fullPhoneNumber}
          callSid={callSid}
        />
      )}

      {/* Dialer buttons */}
      <div
        className={`grid grid-cols-3 gap-2 mb-4 ${
          localCallState.isConnected ? "opacity-50" : ""
        }`}
      >
        {[1, 2, 3, 4, 5, 6, 7, 8, 9, "*", 0, "#"].map((num) => (
          <DialButton
            key={num}
            value={num.toString()}
            onClick={() => handleNumberClick(num.toString())}
            disabled={localCallState.isConnected}
            className={num === 0 ? "dial-button-zero" : ""}
          />
        ))}
      </div>

      {/* Call/Hangup button */}
      <div className="flex justify-center">
        {!localCallState.isConnected ? (
          <motion.button
            onClick={handleCall}
            disabled={localCallState.isConnecting || !isReady || !phoneNumber}
            className={`flex items-center justify-center w-16 h-16 rounded-full ${
              localCallState.isConnecting
                ? "bg-yellow-500"
                : phoneNumber && isReady
                ? "bg-green-500 hover:bg-green-600"
                : "bg-gray-300"
            } text-white transition-colors`}
            whileTap={{ scale: 0.95 }}
            whileHover={phoneNumber && isReady ? { scale: 1.05 } : {}}
          >
            {localCallState.isConnecting ? (
              <div className="animate-spin h-6 w-6 border-2 border-white border-t-transparent rounded-full"></div>
            ) : (
              <PhoneIcon className="h-8 w-8" />
            )}
          </motion.button>
        ) : (
          <div className="flex flex-col items-center space-y-4">
            <motion.button
              onClick={handleHangUp}
              className="flex items-center justify-center w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 text-white"
              whileTap={{ scale: 0.95 }}
              whileHover={{ scale: 1.05 }}
            >
              <PhoneIcon className="h-8 w-8 rotate-135" />
            </motion.button>
            <motion.button
              onClick={handleMuteToggle}
              className={`p-4 rounded-full ${
                localCallState.isMuted
                  ? "bg-red-500 text-white"
                  : "bg-gray-200 text-gray-700"
              } hover:bg-opacity-90 transition-colors`}
              whileTap={{ scale: 0.95 }}
              whileHover={{ scale: 1.05 }}
            >
              {localCallState.isMuted ? (
                <SpeakerXMarkIcon className="h-6 w-6" />
              ) : (
                <SpeakerWaveIcon className="h-6 w-6" />
              )}
              <span className="sr-only">
                {localCallState.isMuted ? "Unmute" : "Mute"}
              </span>
            </motion.button>
          </div>
        )}
      </div>

      {/* Call Info component for in-call UI */}
      {localCallState.isConnected && (
        <div className="mt-4">
          <CallInfo />
        </div>
      )}
    </div>
  );
}
